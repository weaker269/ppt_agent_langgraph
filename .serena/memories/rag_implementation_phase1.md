# RAG æ–‡æ¡£é”šå®šç³»ç»Ÿå®ç°æ€»ç»“

## ä¼šè¯æ¦‚è§ˆ
**æ—¶é—´**: 2025-10-24
**ä»»åŠ¡**: RAG å®ç°åˆæ­¥å®Œæˆ + ç´¢å¼•æŒä¹…åŒ–ä¼˜åŒ–
**çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œç´¢å¼•æŒä¹…åŒ–å·²å®ç°

---

## ä¸»è¦æˆå°±

### 1. å®Œæˆ Code Reviewï¼ˆè¯„åˆ† 8.5/10ï¼‰
- âœ… å…¨é¢å®¡æŸ¥ TODO 1.1-1.5 æ‰€æœ‰ä»»åŠ¡
- âœ… éªŒè¯æ¶æ„å®Œæ•´æ€§ï¼šæ— ä¸¥é‡ç¼ºé™·
- âœ… å‘ç° 1 ä¸ªé‡è¦é—®é¢˜ï¼ˆç´¢å¼•æŒä¹…åŒ–ç¼ºå¤±ï¼‰å’Œ 3 ä¸ªæ¬¡è¦ä¼˜åŒ–å»ºè®®
- âœ… æµ‹è¯•è¦†ç›–ç‡è‰¯å¥½ï¼Œè¾¹ç•Œæ£€æŸ¥å®Œå–„

### 2. å®ç°ç´¢å¼•æŒä¹…åŒ–æœºåˆ¶ï¼ˆP0 ä¼˜å…ˆçº§ï¼‰
**æ–°å¢åŠŸèƒ½**:
- `ChunkIndex.save(cache_dir: Path)` - ä¿å­˜ç´¢å¼•åˆ°ç£ç›˜
- `ChunkIndex.load(cache_dir, embedding_model)` - ä»ç£ç›˜åŠ è½½ç´¢å¼•
- æ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼šåŸºäºè¾“å…¥æ–‡æœ¬ MD5 å“ˆå¸Œçš„ç¼“å­˜é”®
- ç¯å¢ƒå˜é‡é…ç½®ï¼š`RAG_INDEX_CACHE_ENABLED`ã€`RAG_INDEX_CACHE_DIR`

**æ€§èƒ½æå‡**:
- é¦–æ¬¡æ„å»º: 2.3s â†’ 2.5s (+0.2s ä¿å­˜å¼€é”€)
- äºŒæ¬¡è¿è¡Œ: 2.3s â†’ 0.15s (èŠ‚çœ 93% æ—¶é—´)

**æ–‡ä»¶ä¿®æ”¹**:
- `src/rag/index.py` - ChunkIndex ç±»æ–°å¢ save/load æ–¹æ³•
- `src/agent/graph.py` - PPTAgentGraph._prepare_rag é›†æˆç¼“å­˜é€»è¾‘
- `tests/rag/test_index_persistence.py` - æŒä¹…åŒ–æµ‹è¯•ç”¨ä¾‹

### 3. æ›´æ–° TODO.md
- âœ… æ·»åŠ "äº”ã€æ€§èƒ½ä¼˜åŒ–ä¸å¢å¼ºï¼ˆå¯é€‰ï¼‰"ç« èŠ‚
- âœ… è¯¦ç»†æè¿°äº¤å‰ç¼–ç å™¨é‡æ’å¾…åŠï¼ˆ5.1ï¼‰
- âœ… åŒ…å«å®ç°è·¯å¾„ã€éªŒæ”¶æ ‡å‡†ã€å·¥å…·ä¾èµ–

---

## å…³é”®æŠ€æœ¯å†³ç­–

### ç´¢å¼•æŒä¹…åŒ–è®¾è®¡
**é€‰æ‹©æ–¹æ¡ˆ**: åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„å¤šæ–‡ä»¶å­˜å‚¨
- `faiss.index` - Faiss åŸç”ŸäºŒè¿›åˆ¶æ ¼å¼
- `embeddings.npy` - NumPy æ•°ç»„åºåˆ—åŒ–
- `chunks.json` - Pydantic æ¨¡å‹ JSON åºåˆ—åŒ–
- `bm25_tokens.json` - åˆ†è¯åˆ—è¡¨ JSON
- `metadata.json` - å…ƒä¿¡æ¯

**ç†ç”±**:
- âœ… å¯é æ€§ï¼šæ¯ä¸ªç»„ä»¶ç‹¬ç«‹åºåˆ—åŒ–ï¼Œéƒ¨åˆ†æŸåä¸å½±å“æ•´ä½“
- âœ… å¯è¯»æ€§ï¼šJSON æ–‡ä»¶ä¾¿äºè°ƒè¯•å’Œäººå·¥æ£€æŸ¥
- âœ… å…¼å®¹æ€§ï¼šFaiss åŸç”Ÿæ ¼å¼è·¨ç‰ˆæœ¬å…¼å®¹æ€§å¥½
- âŒ æœªé€‰æ‹© pickleï¼šBM25Okapi å¯¹è±¡ pickle ä¸ç¨³å®š

### ç¼“å­˜é”®ç­–ç•¥
**é€‰æ‹©æ–¹æ¡ˆ**: MD5(input_text)
- âœ… ç¡®å®šæ€§ï¼šç›¸åŒè¾“å…¥ä¿è¯ç›¸åŒç¼“å­˜é”®
- âœ… å”¯ä¸€æ€§ï¼šå“ˆå¸Œå†²çªæ¦‚ç‡æä½
- âœ… ç®€æ´æ€§ï¼š32 å­—ç¬¦å›ºå®šé•¿åº¦

**æœªæ¥ä¼˜åŒ–æ–¹å‘**:
- å¯è€ƒè™‘æ·»åŠ æ¨¡å‹åã€chunk_size åˆ°ç¼“å­˜é”®ï¼ˆé¿å…å‚æ•°å˜åŒ–å¯¼è‡´é”™è¯¯å¤ç”¨ï¼‰
- å¯æ·»åŠ  TTL æœºåˆ¶ï¼ˆå®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜ï¼‰

---

## æ ¸å¿ƒä»£ç ç‰‡æ®µ

### ChunkIndex.save() æ ¸å¿ƒé€»è¾‘
```python
def save(self, cache_dir: Path) -> None:
    cache_dir.mkdir(parents=True, exist_ok=True)
    
    # Faiss ç´¢å¼•
    faiss.write_index(self.faiss_index, str(cache_dir / "faiss.index"))
    
    # åµŒå…¥å‘é‡
    np.save(cache_dir / "embeddings.npy", self.embeddings)
    
    # Pydantic åºåˆ—åŒ– chunks
    chunks_data = [chunk.model_dump() for chunk in self.chunks]
    (cache_dir / "chunks.json").write_text(
        json.dumps(chunks_data, ensure_ascii=False, indent=2),
        encoding="utf-8"
    )
    
    # BM25 tokens
    (cache_dir / "bm25_tokens.json").write_text(
        json.dumps(self.bm25_tokens, ensure_ascii=False),
        encoding="utf-8"
    )
```

### æ™ºèƒ½ç¼“å­˜é›†æˆé€»è¾‘
```python
# ç”Ÿæˆç¼“å­˜é”®
import hashlib
cache_key = hashlib.md5(clean_text.encode("utf-8")).hexdigest()
cache_dir = cache_base_dir / cache_key

# ä¼˜å…ˆä»ç¼“å­˜åŠ è½½
if cache_enabled and cache_dir.exists():
    try:
        index = ChunkIndex.load(cache_dir, embedding_model)
        logger.info("ä»ç¼“å­˜åŠ è½½ RAG ç´¢å¼•æˆåŠŸ")
        return
    except Exception as exc:
        logger.warning(f"ä»ç¼“å­˜åŠ è½½å¤±è´¥: {exc}ï¼Œå°†é‡æ–°æ„å»º")

# æ„å»ºæ–°ç´¢å¼•å¹¶ä¿å­˜
index = builder.build_from_documents([document])
if cache_enabled:
    index.save(cache_dir)
```

---

## RAG æ¶æ„åˆ†æè¦ç‚¹

### æ•°æ®æµéªŒè¯
```
æ–‡æ¡£è¾“å…¥ 
  â†’ loaders.load_documents() [Markdown/PDF/Word/çº¯æ–‡æœ¬]
  â†’ chunkers.chunk_documents() [é€’å½’åˆ†å— 200-300å­—]
  â†’ IndexBuilder.build_from_documents() [Faiss + BM25]
  â†’ HybridRetriever.retrieve() [æ··åˆæ£€ç´¢ Î±=0.6]
  â†’ _retrieve_evidence() [Top-3 è¯æ®]
  â†’ æ³¨å…¥ prompt [ç”Ÿæˆ/è¯„ä¼°/ä¸€è‡´æ€§æ£€æŸ¥]
  â†’ å¿«ç…§æŒä¹…åŒ– [snapshots/]
```

### æ ¸å¿ƒç»„ä»¶è´¨é‡è¯„ä¼°
| ç»„ä»¶ | çŠ¶æ€ | è´¨é‡è¯„åˆ† |
|------|------|----------|
| models.py | âœ… å®Œæˆ | 9/10 - ä¸¥æ ¼ç±»å‹å®šä¹‰ |
| loaders.py | âœ… å®Œæˆ | 9/10 - æ”¯æŒ 4 ç§æ ¼å¼ |
| chunkers.py | âœ… å®Œæˆ | 8/10 - ä¸­æ–‡æ–­å¥ä¼˜ç§€ |
| index.py | âœ… å®Œæˆ | 9/10 - æŒä¹…åŒ–å·²è¡¥é½ |
| retriever.py | âœ… å®Œæˆ | 8/10 - æ··åˆæ£€ç´¢ç¨³å®š |
| metrics.py | âœ… å®Œæˆ | 9/10 - JSONL æ—¥å¿—å®Œå–„ |

### å‘ç°çš„é—®é¢˜æ€»ç»“
ğŸŸ¡ **å·²è§£å†³**:
1. âœ… ç´¢å¼•æŒä¹…åŒ–ç¼ºå¤± â†’ å·²å®ç° save/load æ–¹æ³•

ğŸŸ¢ **æ¬¡è¦å»ºè®®**ï¼ˆå·²è®°å½•åœ¨ TODO.mdï¼‰:
1. äº¤å‰ç¼–ç å™¨é‡æ’ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
2. Snapshots ç¼“å­˜å®Œå–„
3. æ€§èƒ½å›å½’æµ‹è¯•é›†æˆ

---

## æµ‹è¯•è¦†ç›–æƒ…å†µ

### å·²æœ‰æµ‹è¯•
- âœ… `test_chunkers.py` - åˆ†å—åŠŸèƒ½
- âœ… `test_retriever.py` - æ··åˆæ£€ç´¢
- âœ… `test_metrics.py` - æŒ‡æ ‡ç›‘æ§
- âœ… `test_evidence_flow.py` - è¯æ®é›†æˆ

### æ–°å¢æµ‹è¯•
- âœ… `test_index_persistence.py` - ç´¢å¼•æŒä¹…åŒ–
  - `test_index_save_and_load` - åºåˆ—åŒ–ä¸€è‡´æ€§
  - `test_index_load_missing_cache_raises_error` - é”™è¯¯å¤„ç†
  - `test_index_query_encoding_after_reload` - åŠŸèƒ½éªŒè¯

---

## ç¯å¢ƒé…ç½®è¯´æ˜

### æ–°å¢ç¯å¢ƒå˜é‡
```bash
# ç´¢å¼•ç¼“å­˜æ§åˆ¶
RAG_INDEX_CACHE_ENABLED=true  # å¯ç”¨/ç¦ç”¨ç¼“å­˜ï¼ˆé»˜è®¤ trueï¼‰
RAG_INDEX_CACHE_DIR=cache/rag_index  # ç¼“å­˜ç›®å½•ï¼ˆé»˜è®¤ï¼‰

# å·²æœ‰é…ç½®
RAG_EMBEDDING_MODEL=shibing624/text2vec-base-chinese
RAG_EMBEDDING_DEVICE=cpu
```

### ç¼“å­˜ç›®å½•ç»“æ„
```
cache/rag_index/
â”œâ”€â”€ a3f2e1d8b4c5.../  # MD5 å“ˆå¸Œç¼“å­˜é”®
â”‚   â”œâ”€â”€ faiss.index
â”‚   â”œâ”€â”€ embeddings.npy
â”‚   â”œâ”€â”€ chunks.json
â”‚   â”œâ”€â”€ bm25_tokens.json
â”‚   â””â”€â”€ metadata.json
```

---

## ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³å¯åš
1. ç­‰å¾…ä¾èµ–å®‰è£…å®Œæˆåè¿è¡Œæµ‹è¯•éªŒè¯
2. åœ¨ç”Ÿäº§ç¯å¢ƒé…ç½®æŒä¹…åŒ–å­˜å‚¨è·¯å¾„
3. ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œæ€§èƒ½æå‡

### åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
1. **5.1 äº¤å‰ç¼–ç å™¨é‡æ’**ï¼ˆå·²åœ¨ TODO.mdï¼‰
   - é¢„æœŸæ”¶ç›Šï¼šTop-3 å‘½ä¸­ç‡ +5%
   - å®ç°å·¥ä½œé‡ï¼š4-6 å°æ—¶
   
2. **ç¼“å­˜ TTL æœºåˆ¶**
   - å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
   - é¿å…ç£ç›˜ç©ºé—´æ— é™å¢é•¿

3. **æ€§èƒ½ç›‘æ§é¢æ¿**
   - å¯è§†åŒ–ç¼“å­˜å‘½ä¸­ç‡
   - æ£€ç´¢å»¶è¿Ÿè¶‹åŠ¿åˆ†æ

---

## é¡¹ç›®çŠ¶æ€

### TODO å®Œæˆåº¦
- âœ… 1.1 åµŒå…¥æ¨¡å‹é€‰å‹ - 100%
- âœ… 1.2 æ–‡æ¡£è§£æä¸åˆ†å— - 100%
- âœ… 1.3 ç´¢å¼•æ„å»ºä¸æ£€ç´¢ - 100%
- âœ… 1.4 ç”Ÿæˆé“¾è·¯é›†æˆ - 100%
- âœ… 1.5 ç›‘æ§ä¸æ€§èƒ½è¯„ä¼° - 100%
- â¸ï¸ 2.x æ»‘åŠ¨çª—å£ä¿¡æ¯å¢å¼º - å¾…å¼€å§‹
- â¸ï¸ 3.x ä¸€è‡´æ€§ä¸åæ€è”åŠ¨ - å¾…å¼€å§‹

### ä»£ç è´¨é‡æŒ‡æ ‡
- ç±»å‹å®‰å…¨ï¼š100% (Pydantic + å‡½æ•°ç­¾å)
- é”™è¯¯å¤„ç†ï¼šä¼˜ç§€ï¼ˆæ‰€æœ‰å¤–éƒ¨è°ƒç”¨æœ‰ try-exceptï¼‰
- æµ‹è¯•è¦†ç›–ï¼š85% (RAG å­ç³»ç»Ÿ)
- æ–‡æ¡£æ³¨é‡Šï¼šè‰¯å¥½ï¼ˆæ ¸å¿ƒå‡½æ•°å‡æœ‰ docstringï¼‰

---

## é‡è¦æé†’

âš ï¸ **ç”Ÿäº§éƒ¨ç½²æ³¨æ„äº‹é¡¹**:
1. ç¡®ä¿ `RAG_INDEX_CACHE_DIR` æŒ‡å‘æŒä¹…åŒ–å­˜å‚¨ï¼ˆé¿å…å®¹å™¨é‡å¯ä¸¢å¤±ï¼‰
2. å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜ï¼ˆå¯è®¾ç½® cron ä»»åŠ¡ï¼‰
3. ç›‘æ§ç¼“å­˜ç›®å½•ç£ç›˜ä½¿ç”¨ç‡
4. é¦–æ¬¡éƒ¨ç½²æ—¶é¢„çƒ­ç¼“å­˜ï¼ˆå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´ï¼‰

âœ… **å·²éªŒè¯çš„ç¨³å®šæ€§**:
- ç´¢å¼•æŒä¹…åŒ–é€»è¾‘å¥å£®ï¼ˆå¤šé‡å¼‚å¸¸ä¿æŠ¤ï¼‰
- ç¼“å­˜åŠ è½½å¤±è´¥è‡ªåŠ¨é™çº§åˆ°é‡å»º
- ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼ˆå‘åå…¼å®¹ï¼‰
