## 优化路线图（RAG 文档锚定 + PPT 生成链路增强）

> 状态标记说明：`[ ]` 待处理 · `[~]` 进行中 · `[x]` 完成  
> 负责人默认团队协作，如需指派请在括号内补充姓名

### 一、文档锚定（方案二：层级分块 + 语义检索 RAG）

- [ ] 基础设施：确认可用的中文嵌入模型与向量索引方案（优先考虑本地部署 text2vec + Faiss，若需云端服务标记合规要求）
- [ ] 文本预处理与分块策略实现  
  - [ ] 统一抽象 `DocumentChunk` 结构，支持来源文件、章节、偏移量等元数据  
  - [ ] 实现递归分割：章节（Markdown 标题/结构化标记）→ 段落 → 句群；控制块长 200~300 汉字，并设置 1~2 句重叠  
  - [ ] 针对非结构化格式（PDF/Word/纯文本）建立统一解析入口，确保传入分块器的文本不含噪声
- [ ] 向量检索管线  
  - [ ] 构建离线索引构建器，支持批量增量更新与缓存  
  - [ ] 实现双通道召回：BM25/关键字 + 向量检索，支持结果合并与去重  
  - [ ] 增加精排阶段（首选交叉编码器 reranker，不可用时 fallback 至嵌入得分重排）
- [ ] 生成阶段集成  
  - [ ] 在 `SlidingWindowContentGenerator._create_content_slide` 中注入召回的证据块，并限制 prompt 中证据总字数  
  - [ ] 为质量评估与一致性检查同步提供同一批证据，以便形成闭环  
  - [ ] 记录检索元数据到快照与结果文件，支撑回溯
- [ ] 验证与回退  
  - [ ] 设计单元测试 / 集成测试验证检索准确率（覆盖长文、多文档、交叉引用）  
  - [ ] 明确检索失败或命中为空时的回退策略（可降级至 Outline-derived 片段或启发式段落抽取）  
  - [ ] 初步性能评估：统计平均检索耗时、prompt 长度变化、模型调用成本

### 二、滑动窗口强化

- [ ] 复用 `SlidingSummary`：生成结构化摘要（主旨、核心概念、逻辑衔接）并输出为 prompt 片段  
- [ ] 修改 `_format_context` 输出，改为摘要文本而非纯标题列表，必要时加入上一页关键数据点  
- [ ] 在质量评估与反思提示词中同步注入上述摘要，确保上下游上下文一致  
- [ ] 增加窗口长度与信息量的可配置项（允许按章节动态调整）

### 三、一致性与反思联动

- [ ] 将检索到的证据块与滑窗摘要同时提供给质量评估 LLM，提升对跨页问题的感知能力  
- [ ] 若质量评估未过阈值，反思提示词需携带：原文证据、滑窗摘要、质量反馈关键信息  
- [ ] 针对一致性检查结果，支持将严重问题映射回具体 evidence 块，辅助人工校验  
- [ ] 设计回归测试（或快照对比）保障反思机制不会破坏已有格式与布局

### 四、文档更新与协作

- [ ] 随任务推进实时更新本 TODO，完成项请将 `[ ]` 修改为 `[x]` 并补充简要结果/链接  
- [ ] 重要设计决策、接口约定、配置变化需同步到 `AGENTS.md` 或相关文档（详见下方铁律）

---

## 优化铁律与原则

1. **证据优先**：所有内容生成与评估必须基于原文检索到的证据块，禁止孤立幻想。  
2. **上下游一致**：滑动窗口摘要、检索证据在生成、质量评估与一致性检查中保持同源输入。  
3. **可回溯性**：每个生成的幻灯片需记录其依赖的文档块 ID，支持后续审计与调试。  
4. **可降级**：检索失败或索引不可用时，提供明确的降级路径，并提示风险。  
5. **性能透明**：记录检索与模型调用的时延与成本变化，定期评估优化效果。
