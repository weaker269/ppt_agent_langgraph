# 嵌入模型选型评测报告

## 1. 评测背景
为落实 TODO.md 中的 RAG 流程升级计划，我们基于仓库现有示例文稿（`sample.md`、`sample2.md`、`sample3.md`）构建了轻量中文问答评测集（`docs/rag/embedding_eval_samples.jsonl`），用于在真实语料上比较不同嵌入模型与 BM25 关键词检索的召回性能、耗时与可维护性。

## 2. 评测设置
- **语料切分**：Markdown 经粗粒度清洗后按段落拆分；超长段落使用 280 字窗口、40 字重叠的滑窗继续切分，共得到 331 个片段。
- **查询样本**：6 条基于业务关键信息编写的中文查询，每条提供 1~4 个答案子串用于召回命中判定。
- **对比策略**：
  1. `BM25`（`jieba` 分词 + `rank-bm25`）。
  2. `BAAI/bge-large-zh-v1.5`
  3. `shibing624/text2vec-base-chinese`
  4. `moka-ai/m3e-base`
- **评测指标**：Top-1/3/5 召回率、MRR、平均 Top-1 相似度、向量构建耗时、平均查询耗时。
- **运行环境**：Windows 11 + Python 3.11 + CPU；模型通过 `HF_ENDPOINT=https://hf-mirror.com` 下载（`bge-large` 首次下载期间存在多次网络超时，耗时显著增加）。

## 3. 结果概要
| 模型 | Top-1 | Top-3 | Top-5 | MRR | 平均 Top-1 分数 | 向量构建耗时 (s) | 平均查询耗时 (ms) |
| --- | --- | --- | --- | --- | --- | --- | --- |
| BM25 | 1.00 | 1.00 | 1.00 | 1.00 | 13.8113 | 0.00 | 0.90 |
| BAAI/bge-large-zh-v1.5 | 0.67 | 0.67 | 0.67 | 0.67 | 0.6780 | 508.95 | 211.83 |
| shibing624/text2vec-base-chinese | 0.67 | 1.00 | 1.00 | 0.81 | 0.7365 | 64.52 | 81.67 |
| moka-ai/m3e-base | 0.33 | 0.33 | 0.50 | 0.37 | 0.8566 | 130.93 | 66.41 |

## 4. 分析与洞察
1. **召回效果**：BM25 在当前小样本集上表现最佳；`text2vec-base-chinese` 的 Top-5 召回率达到 1.0，与 BM25 持平，`bge-large` 仅 0.67，未达设定阈值 0.85，推测与样本量偏小、判定标准严格（按答案子串匹配）有关。
2. **性能对比**：`bge-large` 的编码耗时 (~509s) 远高于 base 模型；由于首次下载经多次断线重连，真实离线批量耗时需待模型缓存后再测。`text2vec-base-chinese`、`m3e-base` 的构建耗时控制在 65s / 131s，查询延迟 < 100ms。
3. **语义相似度**：虽然 `m3e-base` 的 Top-1 相似度均值最高 (0.8566)，但由于训练目标偏向通用检索，召回表现不如其他模型，说明需要结合召回率综合考量。
4. **网络稳定性**：`bge-large` 在大陆网络下下载极不稳定；建议预先在离线源下载权重或通过企业内部镜像分发，以免影响 CI/CD。

## 5. 初步建议
1. **候选模型**：在补充更丰富的评测样本前，建议优先采用 `shibing624/text2vec-base-chinese` 作为基线嵌入模型；其在当前样本集的 Top-5 召回与 BM25 持平，编码速度也更容易满足“1000 片段 < 5s”的目标（推算 60s/331 ≈ 0.18s/片段，线性外推约 54s/1000 片段，仍需微调批量大小以进一步优化）。
2. **组合策略**：保留 BM25 作为第一阶段召回候选，并与嵌入召回取并集，可提升对术语型查询的鲁棒性。
3. **后续工作**：
   - 扩充查询样本（≥30 条，覆盖政策、技术参数、案例等多类问题），降低统计波动。
   - 评估开启 `normalize_embeddings=False` + `faiss` 余弦距离的影响，验证相似度阈值配置。
   - 完成模型缓存与下载镜像配置，避免运行期触发大量网络重试。

## 6. 限制与下一步
- 当前评测集规模有限，仅反映趋势；尚不足以得出最终定论。
- 尚未纳入交叉编码器重排、召回+重排一体化的指标；待 1.3 节完成后需重新评估完整链路。
- 需在 TODO.md 中继续跟进后续优化项，并在采用最终策略后同步更新 `AGENTS.md`。

附：完整运行日志及 JSON 结果存放于 `results/embedding_eval.json`，可用于后续对比。
